<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Defang WebSocket Demo</title>
    {% load static %}
    <!-- If Tailwind is available via CDN or staticfiles, include it here -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animated blue glowing gradient background */
        @keyframes gradientRotate {
            0% {
                transform: rotate(0deg) scale(1.5);
            }
            50% {
                transform: rotate(180deg) scale(1.7);
            }
            100% {
                transform: rotate(360deg) scale(1.5);
            }
        }
        
        @keyframes glowPulse {
            0%, 100% {
                opacity: 0.4;
                filter: blur(60px);
            }
            50% {
                opacity: 0.7;
                filter: blur(80px);
            }
        }
        
        @keyframes glowPulse2 {
            0%, 100% {
                opacity: 0.3;
                filter: blur(70px);
            }
            50% {
                opacity: 0.6;
                filter: blur(90px);
            }
        }
        
        .space-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        
        .gradient-orb {
            position: absolute;
            border-radius: 50%;
            animation: gradientRotate 20s linear infinite;
            will-change: transform, opacity;
        }
        
        .orb-1 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.5) 0%, rgba(37, 99, 235, 0.3) 30%, transparent 70%);
            top: -200px;
            left: -200px;
            animation: gradientRotate 20s linear infinite, glowPulse 8s ease-in-out infinite;
        }
        
        .orb-2 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(96, 165, 250, 0.4) 0%, rgba(59, 130, 246, 0.2) 40%, transparent 70%);
            bottom: -150px;
            right: -150px;
            animation: gradientRotate 25s linear infinite reverse, glowPulse2 10s ease-in-out infinite;
        }
        
        .orb-3 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.3) 0%, rgba(96, 165, 250, 0.15) 50%, transparent 70%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: gradientRotate 30s linear infinite, glowPulse 12s ease-in-out infinite;
        }
        
        /* Light mode background */
        body.light-mode .space-bg {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 50%, #dbeafe 100%);
        }
        
        /* Dark mode background */
        body:not(.light-mode) .space-bg {
            background: linear-gradient(135deg, #0f172a 0%, #020617 50%, #0c1222 100%);
        }
        
        /* Content glow effect */
        .content-glow {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body.light-mode .content-glow {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .gradient-orb,
            .orb-1,
            .orb-2,
            .orb-3 {
                animation: none;
            }
        }
    </style>
</head>
<body class="min-h-screen min-w-screen flex items-center justify-center">
    <!-- Space-themed animated background -->
    <div class="space-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>
    <div class="w-full max-w-5xl mx-auto flex flex-col md:flex-row gap-8 p-4 md:p-8 relative z-10">
        <!-- Left column: input, logo, docs, status -->
        <div class="flex-1 flex flex-col gap-6 md:max-w-md">
            <div class="flex flex-col items-center gap-4">
                <div class="flex flex-col items-center gap-2">
                    <img
                        src="https://raw.githubusercontent.com/DefangLabs/defang-assets/refs/heads/main/images/logos/logos-with-workmarks/title/defang-title-dark-colour-large.png"
                        alt="Defang Logo"
                        class="max-w-[200px] w-full h-auto"
                    />
                    <p class="text-center text-sm md:text-base text-blue-600 dark:text-blue-400 font-medium">
                        âœ¨ I deployed this to AWS with Defang without ever leaving my browser in 10min
                    </p>
                </div>
                <a
                    href="https://docs.defang.io/docs/intro"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-blue-600 dark:text-blue-400 hover:underline text-base text-center"
                >
                    Defang Documentation
                </a>
            </div>
            <form id="ws-form" class="flex flex-col gap-4 content-glow rounded-lg p-4">
                <label for="ws-input" class="font-semibold text-lg mb-1 text-gray-900 dark:text-white">Summarize your text:</label>
                <textarea
                    id="ws-input"
                    placeholder="Paste or type your text here to be summarized..."
                    class="flex-1 px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-400 bg-white/90 dark:bg-black/60 text-gray-900 dark:text-white min-h-[100px] resize-y"
                    aria-label="Text to summarize"
                    rows="5"
                    required
                ></textarea>
                <button
                    id="ws-send"
                    type="submit"
                    class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-400"
                    disabled
                >
                    Send
                </button>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-gray-600 dark:text-gray-300">Status:</span>
                    <span id="ws-status" class="font-semibold px-2 py-0.5 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">Disconnected</span>
                    <span id="ws-error" class="ml-2 text-xs text-red-500"></span>
                </div>
            </form>
        </div>
        <!-- Right column: messages -->
        <div class="flex-1 flex flex-col">
            <div class="font-semibold text-lg mb-2 text-gray-900 dark:text-white">Messages from backend:</div>
            <div id="ws-messages" class="flex flex-col gap-2 max-h-[500px] overflow-y-auto pr-2">
                <ul id="ws-messages-list" class="flex flex-col gap-3"></ul>
            </div>
        </div>
    </div>
<script>
(function() {
    // --- Light/Dark Mode Detection ---
    const darkModeMediaQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
    
    function updateTheme() {
        if (!darkModeMediaQuery) {
            // Default to dark mode if matchMedia not supported
            document.body.classList.remove('light-mode');
            return;
        }
        const isDark = darkModeMediaQuery.matches;
        if (!isDark) {
            document.body.classList.add('light-mode');
        } else {
            document.body.classList.remove('light-mode');
        }
    }
    updateTheme();
    // Listen for theme changes
    if (darkModeMediaQuery) {
        darkModeMediaQuery.addEventListener('change', updateTheme);
    }

    // --- Configuration ---
    // Dynamically build wsUrl based on current page origin
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${wsScheme}://${window.location.host}/ws/summary/`;
    // If you want to set this dynamically from Django context, use a template variable
    // Example: wsUrl = "{{ ws_url|escapejs }}";

    // --- DOM Elements ---
    const input = document.getElementById('ws-input');
    const sendBtn = document.getElementById('ws-send');
    const statusSpan = document.getElementById('ws-status');
    const errorSpan = document.getElementById('ws-error');
    const messagesList = document.getElementById('ws-messages-list');
    const form = document.getElementById('ws-form');

    // --- State ---
    let ws = null;
    let connected = false;
    let reconnectTimeout = null;
    let messages = [];

    // --- Helpers ---
    function statusTagColor(status) {
        switch (status) {
            case 'starting': return 'bg-blue-100 text-blue-800 border-blue-300';
            case 'processing': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
            case 'info': return 'bg-gray-100 text-gray-800 border-gray-300';
            case 'done': return 'bg-green-100 text-green-800 border-green-300';
            default: return 'bg-gray-200 text-gray-700 border-gray-300';
        }
    }
    function setStatus(isConnected) {
        statusSpan.textContent = isConnected ? 'Connected' : 'Disconnected';
        statusSpan.className =
            'font-semibold px-2 py-0.5 rounded ' +
            (isConnected
                ? 'bg-green-100 text-green-800 border border-green-300'
                : 'bg-gray-200 text-gray-800 border border-gray-300');
        sendBtn.disabled = !isConnected || !input.value.trim();
        input.disabled = !isConnected;
    }
    function setError(msg) {
        errorSpan.textContent = msg || '';
    }
    function addMessage(data, timestamp) {
        messages.unshift({data, timestamp});
        renderMessages();
    }
    function renderMessages() {
        messagesList.innerHTML = '';
        if (messages.length === 0) {
            return;
        }
        messages.forEach((msg) => {
            let parsed, status, messageText;
            try {
                parsed = JSON.parse(msg.data);
                status = parsed.status || 'info';
                messageText = parsed.message || msg.data;
            } catch {
                status = 'info';
                messageText = msg.data;
            }
            // Outer li
            const li = document.createElement('li');
            li.className = "flex flex-col gap-1 content-glow rounded p-3 shadow-sm";
            // Status tag
            const tag = document.createElement('span');
            tag.className = `inline-block text-xs font-semibold px-2 py-0.5 rounded border ${statusTagColor(status)}`;
            tag.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            // Message
            const msgDiv = document.createElement('div');
            msgDiv.className = "text-base text-gray-900 dark:text-gray-100";
            msgDiv.textContent = messageText;
            // Timestamp
            const timeDiv = document.createElement('div');
            timeDiv.className = "text-xs text-gray-500 mt-1";
            timeDiv.textContent = new Date(msg.timestamp).toLocaleString();
            li.appendChild(tag);
            li.appendChild(msgDiv);
            li.appendChild(timeDiv);
            messagesList.appendChild(li);
        });
    }
    function connectWebSocket() {
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
            return;
        }
        ws = new window.WebSocket(wsUrl);
        ws.onopen = function() {
            connected = true;
            setStatus(true);
            setError("");
        };
        ws.onclose = function() {
            connected = false;
            setStatus(false);
            // Try to reconnect after 2 seconds
            if (reconnectTimeout) clearTimeout(reconnectTimeout);
            reconnectTimeout = setTimeout(connectWebSocket, 2000);
        };
        ws.onerror = function() {
            setError("WebSocket error");
        };
        ws.onmessage = function(e) {
            addMessage(e.data, new Date().toISOString());
        };
    }

    // --- Event Listeners ---
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (ws && connected) {
            ws.send(JSON.stringify({ text: input.value }));
            input.value = '';
            sendBtn.disabled = true;
        }
    });
    input.addEventListener('input', function() {
        sendBtn.disabled = !connected || !input.value.trim();
    });
    window.addEventListener('focus', function() {
        if (!ws || (ws.readyState !== WebSocket.OPEN && ws.readyState !== WebSocket.CONNECTING)) {
            connectWebSocket();
        }
    });

    // --- Initialize ---
    setStatus(false);
    setError("");
    renderMessages();
    connectWebSocket();
})();
</script>
</body>
</html>
